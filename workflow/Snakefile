from pathlib import Path

configfile: "../conf/config_finemap.yaml"

seqid = config["sample_seqids"]

def ws_path(file_path):
    return str(Path(config.get("path_base"), file_path))

def db_path(file_path):
    return str(Path(config.get("path_data"), file_path))

def ss_path(file_path):
    return str(Path(config.get("path_pwas"), file_path))


rule all:
    input:
        expand(
            #ws_path("output/break/seq.{i}/seq.{i}_loci.tsv"),
            ws_path("logs/cojo/seq.{i}.log"), i = seqid
            )


rule munge_sumstats:
    input:
        ifile = ss_path("seq.{i}/seq.{i}.regenie.tsv.gz")
    output:
        ofile = ws_path("output/munge/seq.{i}_dataset.rds")
    params:
        codes = config.get("path_code"),
        ofile = ws_path("output/munge/seq.{i}")
    log:
        ws_path("logs/munge/seq.{i}.log")
    resources:
        mem_mb = 16000, runtime = 60
#    conda:
#        "envs/r_environment.yml"
#    container:
#        "docker://quay.io/biocontainers/plink2:2.00a5--h4ac6f70_0"
    shell:
        """
        source ~/.bashrc && \
        conda activate r_finemap &&  \
        Rscript scripts/s01_sumstat_munging.R  \
            --pipeline_path {params.codes}  \
            --input {input.ifile}  \
            --is_molQTL FALSE  \
            --type quant  \
            --s NA  \
            --study_id {params.ofile}
        """


rule align_sumstats:
    input:
        ifile = ws_path("output/munge/seq.{i}_dataset.rds")
    output:
        ifile = ws_path("output/align/seq.{i}/seq.{i}_chr{chrom}_dataset_aligned.tsv.gz"),
        #lfile = expand(ws_path("output/align/seq.{i}_chr{chrom}_snplist.tsv"), i = seqid, chrom = range(1, 23)),
        #mfile = expand(ws_path("output/align/seq.{i}_chr{chrom}_map.tsv"), i = seqid, chrom = range(1, 23))
    params:
        codes = config.get("path_code"),
        ofile = ws_path("output/align/seq.{i}/seq.{i}"),
        chro  = "{chrom}"
    #log:
    #    ws_path("logs/align/seq.{i}_chr{chrom}.log")
    #conda:
    #    "envs/r_envirnonment.yml"
    resources:
        mem_mb = 8000, runtime = 60
    shell:
        """
        source ~/.bashrc && \
        conda activate r_finemap &&  \
        Rscript scripts/s02_sumstat_alignment.R  \
            --pipeline_path {params.codes}  \
            --dataset {input.ifile}  \
            --chr_tabix {params.chro}  \
            --grch 38  \
            --study_id {params.ofile}
        """


rule break_locus:
    input:
        ifile = expand(ws_path("output/align/seq.{i}/seq.{i}_chr{chrom}_dataset_aligned.tsv.gz"), i = seqid, chrom = range(1, 23))
    output:
        ofile = ws_path("output/break/seq.{i}/seq.{i}_loci.tsv"),
        #sfile = ws_path("output/break/seq.{i}/seq.{i}_dataset_aligned.tsv.gz")
    params:
        codes = config.get("path_code"),
        ifile = ws_path("output/align/seq.{i}/seq.{i}"),
        ofile = ws_path("output/break/seq.{i}/seq.{i}"),
        seque = "seq.{i}"
    log:
        ws_path("logs/break/seq.{i}.log")
    resources:
        mem_mb = 8000, runtime = 60
    shell:
        """
        source ~/.bashrc && \
        conda activate r_finemap &&  \
        Rscript scripts/s03_locus_breaker.R  \
            --pipeline_path {params.codes}  \
            --study_id {params.ifile}  \
            --p_thresh1 5e-06  \
            --p_thresh2 1e-04  \
            --outdir {params.ofile}  2> {log}
        """


rule run_cojo:
    input:
        ifile = ws_path("output/break/seq.{i}/seq.{i}_dataset_aligned.tsv.gz")
    output:
        #ofile = ws_path("output/cojo/seq.{i}/seq.{i}")
        ws_path("logs/cojo/seq.{i}.log")
    params:
        codes = config.get("path_code"),
        geno  = config.get("path_geno"),
        ofile = ws_path("output/cojo/seq.{i}/seq.{i}"),
        chr = 9, beg = 136014227, end = 136466717,
        #seque = "seq.{i}"
    log:
        ws_path("logs/cojo/seq.{i}.log")
    resources:
        mem_mb = 8000, runtime = 60
    shell:
        """
        source ~/.bashrc && \
        conda activate r_finemap &&  \
        Rscript scripts/s04_cojo_finemapping.R  \
            --pipeline_path {params.codes}  \
            --dataset_aligned {input.ifile}  \
            --study_id {params.ofile}  \
            --chr   {params.chr}  \
            --start {params.beg}  \
            --end   {params.end}  \
            --bfile {params.geno} \
            --phenotype_id full  \
            --nf_hcoloc_v no_nf  2> {log}
        """

